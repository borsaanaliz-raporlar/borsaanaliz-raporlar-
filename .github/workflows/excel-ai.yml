name: ğŸ¤– Excel-Okuyan AI YanÄ±t (DeepSeek + Groq)

on:
  issues:
    types: [opened]
  workflow_dispatch:

jobs:
  excel-ai:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: ğŸ“¥ Repository'yi Ã§ek
      uses: actions/checkout@v3
      
    - name: ğŸ Python kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
      
    - name: ğŸ“¦ KÃ¼tÃ¼phaneleri kur
      run: |
        pip install pandas openpyxl requests
        echo "âœ… KÃ¼tÃ¼phaneler kuruldu"
      
    - name: ğŸ” Excel dosyalarÄ±nÄ± kontrol et
      run: |
        echo "ğŸ“‚ Mevcut dosyalar:"
        find . -name "*.xls*" -type f | head -10
        echo ""
        echo "ğŸ“Š Excel sayÄ±sÄ±:"
        find . -name "*.xls*" -type f | wc -l
      
    - name: ğŸ¤– Excel AI analizini Ã§alÄ±ÅŸtÄ±r (DEEPSEEK + GROQ HÄ°BRÄ°T)
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: python .github/workflows/excel_ai_analyzer.py "${{ github.event.issue.body }}"
      
    - name: ğŸ“ YanÄ±t dosyasÄ±nÄ± kontrol et
      id: check-response
      run: |
        if [ -f "ai_response.txt" ]; then
          echo "âœ… YanÄ±t dosyasÄ± bulundu. Boyut: $(wc -c < ai_response.txt) byte"
          echo "has_response=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Hata: ai_response.txt bulunamadÄ±!"
          echo "has_response=false" >> $GITHUB_OUTPUT
          echo "ÃœzgÃ¼nÃ¼m, Excel AI yanÄ±tÄ± oluÅŸturulamadÄ±. GitHub Actions loglarÄ±nÄ± kontrol edin." > ai_response.txt
        fi
      
    - name: ğŸ’¬ YanÄ±tÄ± Issue'a ekle
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          let response = "âš ï¸ YanÄ±t oluÅŸturulamadÄ±.";
          
          try {
            if (fs.existsSync('ai_response.txt')) {
              response = fs.readFileSync('ai_response.txt', 'utf8');
            } else {
              response = "âŒ Excel AI analizi Ã§alÄ±ÅŸtÄ± ancak yanÄ±t dosyasÄ± bulunamadÄ±.";
            }
          } catch (e) {
            response = `âŒ Hata: ${e.message}`;
          }
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ“Š **BORSAANALÄ°Z PROFESYONEL TEKNÄ°K ANALÄ°Z RAPORU**\n\n${response}\n\n---\nâš¡ **AI Motor:** DeepSeek + Groq Hibrit\nğŸ“… **Tarih:** ${new Date().toLocaleString('tr-TR')}\nğŸ“Œ **Not:** Bu analiz yatÄ±rÄ±m tavsiyesi deÄŸildir.`
          });
          
          try {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['excel-ai', 'teknik-analiz', 'deepseek-groq']
            });
          } catch (e) {
            console.log("Label eklenemedi:", e.message);
          }
