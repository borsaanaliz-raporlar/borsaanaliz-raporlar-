name: ğŸ¤– Excel-Okuyan AI YanÄ±t (DeepSeek + Groq)

on:
  issues:
    types: [opened]
  workflow_dispatch:

jobs:
  excel-ai:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: ğŸ“¥ Repository'yi Ã§ek
      uses: actions/checkout@v3
      
    - name: ğŸ Python kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
      
    - name: ğŸ“¦ KÃ¼tÃ¼phaneleri kur
      run: |
        pip install pandas openpyxl requests
        echo "âœ… KÃ¼tÃ¼phaneler kuruldu"
      
    - name: ğŸ” Excel dosyalarÄ±nÄ± kontrol et
      run: |
        echo "ğŸ“‚ raporlar klasÃ¶rÃ¼ iÃ§eriÄŸi:"
        ls -la raporlar/ || echo "âš ï¸ raporlar klasÃ¶rÃ¼ yok!"
        echo ""
        echo "ğŸ“Š En son Excel:"
        ls -la raporlar/*.xls* 2>/dev/null | tail -5 || echo "Excel dosyasÄ± yok!"
      
    - name: ğŸ¤– Excel AI analizini Ã§alÄ±ÅŸtÄ±r
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: python .github/workflows/excel_ai_analyzer.py "${{ github.event.issue.body }}"
      
    - name: ğŸ“ YanÄ±t dosyasÄ±nÄ± kontrol et
      id: check-response
      run: |
        if [ -f "ai_response.txt" ]; then
          echo "âœ… YanÄ±t dosyasÄ± bulundu! Boyut: $(wc -c < ai_response.txt) byte"
          echo "has_response=true" >> $GITHUB_OUTPUT
          echo "ğŸ“„ Ä°lk 200 karakter:"
          head -c 200 ai_response.txt
          echo ""
        else
          echo "âŒ Hata: ai_response.txt bulunamadÄ±!"
          echo "has_response=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ AI analizi Ã§alÄ±ÅŸmadÄ± - loglarÄ± kontrol edin" > ai_response.txt
        fi
      
    - name: ğŸ’¬ YanÄ±tÄ± Issue'a ekle
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          let response = "âš ï¸ YanÄ±t oluÅŸturulamadÄ±.";
          
          try {
            if (fs.existsSync('ai_response.txt')) {
              response = fs.readFileSync('ai_response.txt', 'utf8');
            } else {
              response = "âŒ Excel AI analizi Ã§alÄ±ÅŸtÄ± ancak yanÄ±t dosyasÄ± bulunamadÄ±.\n\nLÃ¼tfen GitHub Actions loglarÄ±nÄ± kontrol edin.";
            }
          } catch (e) {
            response = `âŒ Hata: ${e.message}`;
          }
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ“Š **BORSAANALÄ°Z PROFESYONEL TEKNÄ°K ANALÄ°Z RAPORU**\n\n${response}\n\n---\nâš¡ **AI Motor:** DeepSeek + Groq Hibrit\nğŸ“… **Tarih:** ${new Date().toLocaleString('tr-TR')}\nğŸ“Œ **Kaynak:** raporlar/${context.repo.repo}\n\nâš ï¸ **YatÄ±rÄ±m tavsiyesi deÄŸildir.**`
          });
          
          console.log("âœ… Issue yanÄ±tÄ± eklendi!");
