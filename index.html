<!-- index.html (TAM ENTEGRE) -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BORSAANALIZ V11 - GÃ¼nlÃ¼k Teknik Analiz RaporlarÄ±</title>

<!-- DataTables CSS (rapor gÃ¶rÃ¼ntÃ¼leyicide) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<style>
  /* (Sizin mevcut stilinizi koruyorum, rapor bÃ¶lÃ¼mÃ¼ne ek stiller) */
  *{box-sizing:border-box}
  body{
    font-family:'Segoe UI', Tahoma, Verdana, sans-serif;
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;
    padding:20px;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  .container{
    width:100%;
    max-width:1100px;
    background:#fff;
    border-radius:14px;
    padding:28px;
    box-shadow:0 20px 60px rgba(0,0,0,0.22);
  }

  /* --- Mevcut login tasarÄ±mÄ±nÄ±z --- */
  .logo{text-align:center;margin-bottom:18px}
  .logo h1{color:#667eea;margin-bottom:6px}
  .version-badge{display:inline-block;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:4px 12px;border-radius:12px;font-weight:700}

  .input-group{position:relative;margin:12px 0}
  .input-group input{width:100%;padding:12px 44px;border:2px solid #ddd;border-radius:10px;font-size:15px}
  .input-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%)}

  .login-btn{width:100%;padding:12px;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-weight:700;border:none;cursor:pointer}
  .error{display:none;background:#fee;padding:10px;border-left:4px solid #e74c3c;border-radius:8px;margin-top:10px}

  /* --- Dashboard (giriÅŸ sonrasÄ±) --- */
  #contentBox{display:none}
  .stats{display:flex;gap:12px;margin:16px 0}
  .stat-card{flex:1;background:#f8f9fa;padding:12px;border-radius:8px;text-align:center}
  .file-list{margin-top:12px}

  .file-item{
    display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:10px;background:#f8f9fa;margin-bottom:10px;border:1px solid #eee;
  }
  .file-meta{display:flex;flex-direction:column;gap:6px}
  .file-name{font-weight:700;color:#333}
  .file-actions{display:flex;gap:8px;align-items:center}

  .btn{padding:8px 12px;border-radius:8px;text-decoration:none;color:#fff;font-weight:700;border:none;cursor:pointer}
  .btn-download{background:#28a745}
  .btn-view{background:#667eea}

  .small{font-size:13px;color:#666}

  /* --- RAPOR GÃ–RÃœNTÃœLEYÄ°CÄ° (overlay-style veya iÃ§ alan) --- */
  .report-wrapper{display:none;margin-top:18px;border-top:1px solid #e6e6e6;padding-top:18px}
  .report-layout{display:flex;gap:16px}
  .left-col{width:260px;background:#f4f6f7;border-radius:8px;padding:12px;height:520px;overflow:auto}
  .right-col{flex:1;background:white;border-radius:8px;padding:12px;height:520px;overflow:auto; border:1px solid #eee}

  .sheet-item{padding:8px;border-radius:6px;margin-bottom:8px;cursor:pointer}
  .sheet-item.active{background:linear-gradient(90deg,#667eea,#764ba2);color:#fff}

  .top-actions{display:flex;justify-content:space-between;gap:8px;margin-bottom:12px}
  .back-btn{background:#6c757d;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}

  /* responsive */
  @media(max-width:900px){
    .report-layout{flex-direction:column}
    .left-col{width:100%;height:auto}
    .right-col{height:auto}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>ğŸ“Š BORSAANALIZ V11</h1>
      <p>GÃ¼nlÃ¼k Teknik Analiz RaporlarÄ±</p>
      <span class="version-badge">VERSION 11.0</span>
    </div>

    <!-- LOGIN BOX -->
    <div id="loginBox">
      <h2>ğŸ”’ Ãœye GiriÅŸi</h2>
      <p style="color:#666;margin-bottom:12px">YouTube KatÄ±l grubundan aldÄ±ÄŸÄ±nÄ±z ÅŸifre ile giriÅŸ yapÄ±n</p>

      <div class="input-group">
        <span class="input-icon">ğŸ”‘</span>
        <input id="passwordInput" type="password" placeholder="Åifrenizi girin" autocomplete="off">
      </div>

      <button class="login-btn" onclick="checkPassword()">ğŸš€ Raporlara EriÅŸ</button>
      <div class="error" id="errorMsg">âŒ HatalÄ± ÅŸifre! LÃ¼tfen YouTube gÃ¶nderisinden gÃ¼ncel ÅŸifreyi alÄ±n.</div>

      <a href="https://www.youtube.com" target="_blank" class="small" style="display:block;margin-top:12px">ğŸ“º Åifreyi YouTube'dan Al</a>
    </div>

    <!-- CONTENT BOX -->
    <div id="contentBox">
      <div class="stats">
        <div class="stat-card"><div style="font-size:20px;font-weight:700" id="totalReports">0</div><div class="small">Toplam Rapor</div></div>
        <div class="stat-card"><div style="font-size:20px;font-weight:700">â€”</div><div class="small">Analiz Edilen Hisse</div></div>
        <div class="stat-card"><div style="font-size:20px;font-weight:700">10</div><div class="small">Analiz Sayfa (Max)</div></div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <h3 style="margin:0">ğŸ“ GÃ¼nlÃ¼k Analiz RaporlarÄ±</h3>
        <div>
          <button id="openLatestBtn" class="btn btn-view" style="margin-right:8px">ğŸ“Š En GÃ¼ncel Raporu GÃ¶rÃ¼ntÃ¼le</button>
          <button class="btn btn-download" onclick="downloadLatest()">â¬‡ï¸ En GÃ¼ncel Excel Ä°ndir</button>
        </div>
      </div>

      <div id="fileList" class="file-list"></div>

      <div class="report-wrapper" id="reportWrapper">
        <div class="top-actions">
          <button class="back-btn" onclick="closeReport()">â—€ï¸ Geri DÃ¶n</button>
          <div>
            <a id="downloadCurrentExcel" class="btn btn-download" href="#" download>ğŸ’¾ Excel'i Ä°ndir</a>
          </div>
        </div>

        <div class="report-layout">
          <div class="left-col" id="sheetsList">
            <!-- sayfa isimleri burada listelenecek -->
            <div style="font-weight:700;margin-bottom:8px">Sayfalar</div>
          </div>

          <div class="right-col">
            <div id="reportTitle" style="font-weight:700;margin-bottom:8px">Rapor</div>
            <div id="tableContainer">
              <!-- DataTable burada oluÅŸturulacak -->
              <table id="reportTable" class="display" style="width:100%"></table>
            </div>
          </div>
        </div>

      </div>

      <div style="margin-top:14px" class="warning small">
        <strong>âš ï¸ Ã–nemli UyarÄ±lar:</strong>
        â€¢ Bu raporlar yatÄ±rÄ±m tavsiyesi deÄŸildir â€¢ RaporlarÄ± Ã¼Ã§Ã¼ncÃ¼ kiÅŸilerle paylaÅŸmayÄ±nÄ±z
      </div>

      <div style="margin-top:14px">
        <button class="back-btn" onclick="logout()">ğŸšª GÃ¼venli Ã‡Ä±kÄ±ÅŸ</button>
      </div>

    </div>
  </div>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    // Mevcut ÅŸifre (sizin talimatÄ±nÄ±za gÃ¶re): "ba"
    const correctPassword = "ba";

    // VarsayÄ±lan fallback dosya listesi (eÄŸer tablolar/files_index.json yoksa kullanÄ±lacak)
    const fallbackFiles = [
      {"name":"BORSAANALIZ_V11_TAM_26112025.xlsx","date":"26.11.2025","download_url":"raporlar/BORSAANALIZ_V11_TAM_26112025.xlsx","sheets":[]},
      {"name":"BORSAANALIZ_V11_TAM_25112025.xlsx","date":"25.11.2025","download_url":"raporlar/BORSAANALIZ_V11_TAM_25112025.xlsx","sheets":[]}
    ];

    // Global state
    let filesIndex = [];     // yapÄ± tablolar/files_index.json iÃ§eriÄŸi
    let currentFile = null;  // seÃ§ili dosya objesi
    let currentSheet = null; // seÃ§ili sayfa objesi
    let dt = null;           // DataTables instance

    window.onload = function() {
      if (sessionStorage.getItem('authenticated') === 'true') {
        showContent();
      }
    };

    function checkPassword(){
      const v = document.getElementById('passwordInput').value.trim();
      const err = document.getElementById('errorMsg');
      if (v === correctPassword){
        sessionStorage.setItem('authenticated','true');
        err.style.display = 'none';
        showContent();
      } else {
        err.style.display = 'block';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
      }
    }

    // GiriÅŸ sonrasÄ± gÃ¶sterilecek ÅŸeyler
    async function showContent(){
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('contentBox').style.display = 'block';

      // Ã–nce files_index.json Ã§ekmeye Ã§alÄ±ÅŸ
      try {
        const res = await fetch('tablolar/files_index.json', {cache: "no-store"});
        if (!res.ok) throw new Error('no index');
        filesIndex = await res.json();
      } catch(e) {
        // fallback
        filesIndex = fallbackFiles;
      }

      // Toplam rapor sayÄ±sÄ± ve dosya listesi doldur
      document.getElementById('totalReports').textContent = filesIndex.length;
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';

      // SÄ±rala: en yeni en Ã¼st (dosya adÄ±ndan veya date alanÄ±ndan)
      filesIndex.sort((a,b) => {
        // try parse date from a.date (dd.mm.yyyy)
        const da = parseDate(a.date);
        const db = parseDate(b.date);
        return db - da;
      });

      filesIndex.forEach((f, idx) => {
        const el = document.createElement('div');
        el.className = 'file-item';
        el.innerHTML = `
          <div class="file-meta">
            <div class="file-name">ğŸ“Š ${f.name}</div>
            <div class="small">ğŸ“… ${f.date} â€¢ ğŸ”¢ ${f.sheets.length || 'â€”'} Sayfa</div>
          </div>
          <div class="file-actions">
            <button class="btn btn-view" onclick="openReportFromIndex(${idx})">ğŸ“Š GÃ¶rÃ¼ntÃ¼le</button>
            <a class="btn btn-download" href="${f.download_url}" download>â¬‡ï¸ Ä°ndir</a>
          </div>
        `;
        fileList.appendChild(el);
      });

      // en gÃ¼ncel raporu gÃ¶rÃ¼ntÃ¼le butonu
      document.getElementById('openLatestBtn').onclick = function(){
        if (filesIndex.length>0) openReportFromIndex(0);
        else alert('HiÃ§ rapor bulunamadÄ±.');
      };
    }

    function parseDate(s){
      // beklenen format: "26.11.2025" veya "2025-11-26"
      if (!s) return 0;
      if (s.indexOf('.')>-1){
        const parts = s.split('.');
        if (parts.length===3) return new Date(+parts[2], +parts[1]-1, +parts[0]);
      }
      return new Date(s);
    }

    // Dosya indexindeki belirli dosyayÄ± aÃ§
    async function openReportFromIndex(idx){
      const f = filesIndex[idx];
      if (!f) return alert('Dosya bulunamadÄ±.');
      currentFile = f;

      // Dosya metadata -> download button
      document.getElementById('downloadCurrentExcel').href = f.download_url || '#';

      // Rapor wrapper gÃ¶ster
      document.getElementById('reportWrapper').style.display = 'block';
      // sol menÃ¼ sayfalarÄ± doldur
      const sheetsList = document.getElementById('sheetsList');
      sheetsList.innerHTML = '<div style="font-weight:700;margin-bottom:8px">Sayfalar</div>';

      // EÄŸer f.sheets yoksa (fallback) uyarÄ± ver
      if (!Array.isArray(f.sheets) || f.sheets.length===0){
        sheetsList.innerHTML += '<div class="small">Bu dosya sayfa listesi iÃ§ermiyor.</div>';
        document.getElementById('reportTitle').textContent = f.name;
        // temiz tablo
        renderTable([], []);
        return;
      }

      f.sheets.forEach((sh, i) => {
        const div = document.createElement('div');
        div.className = 'sheet-item' + (i===0 ? ' active' : '');
        div.textContent = sh.name;
        div.onclick = () => { selectSheet(sh, div); };
        sheetsList.appendChild(div);
      });

      // otomatik olarak ilk sayfayÄ± yÃ¼kle
      selectSheet(f.sheets[0], sheetsList.querySelector('.sheet-item'));
    }

    // sayfa seÃ§ildiÄŸinde JSON'dan veriyi Ã§ek & DataTable gÃ¶ster
    async function selectSheet(sheetObj, domEl){
      // active class toggle
      document.querySelectorAll('.sheet-item').forEach(x => x.classList.remove('active'));
      if (domEl) domEl.classList.add('active');

      currentSheet = sheetObj;
      document.getElementById('reportTitle').textContent = (currentFile.name || '') + ' â†’ ' + sheetObj.name;

      // fetch json (sheetObj.json should be relative path e.g. "tablolar/xxx.json")
      if (!sheetObj.json) {
        // fallback: show empty
        renderTable([], []);
        return;
      }

      try {
        const res = await fetch(sheetObj.json + '?t=' + Date.now(), {cache:'no-store'});
        if (!res.ok) throw new Error('json yok');
        const payload = await res.json();
        // payload expected: {columns: [...], rows: [[...],[...],...]}
        renderTable(payload.columns || [], payload.rows || []);
      } catch (e) {
        console.error(e);
        renderTable([], []);
        alert('Bu sayfanÄ±n JSON verisi yÃ¼klenemedi: ' + (sheetObj.json || ''));
      }
    }

    // render DataTable from columns[] and rows[] (rows is array of arrays)
    function renderTable(columns, rows){
      // destroy existing
      if (dt) { try { dt.destroy(); } catch(e) {} }
      const table = $('#reportTable');
      table.empty();

      // if no columns, show placeholder
      if (!columns || columns.length===0){
        table.html('<thead><tr><th>Veri bulunamadÄ±</th></tr></thead><tbody><tr><td>â€”</td></tr></tbody>');
        return;
      }

      // build thead
      let thead = '<thead><tr>';
      columns.forEach(c => { thead += '<th>' + escapeHtml(c) + '</th>'; });
      thead += '</tr></thead>';
      table.append(thead);

      // build rows
      let tbody = '<tbody>';
      rows.forEach(r => {
        tbody += '<tr>';
        r.forEach(cell => {
          tbody += '<td>' + (cell === null || cell === undefined ? '' : escapeHtml('' + cell)) + '</td>';
        });
        tbody += '</tr>';
      });
      tbody += '</tbody>';
      table.append(tbody);

      // init datatable
      dt = table.DataTable({
        pageLength: 25,
        lengthMenu: [10,25,50,100,-1],
        order: []
      });
    }

    function escapeHtml(s){
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function closeReport(){
      document.getElementById('reportWrapper').style.display = 'none';
    }

    function logout(){
      if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')){
        sessionStorage.removeItem('authenticated');
        location.reload();
      }
    }

    function downloadLatest(){
      if (filesIndex.length>0){
        const latest = filesIndex[0];
        window.open(latest.download_url, '_blank');
      } else alert('Ä°ndirilecek rapor bulunamadÄ±.');
    }
  </script>
</body>
</html>
